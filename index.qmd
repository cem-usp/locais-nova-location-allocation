```{r}
#| label: setup
#| include: false

library(here)

source(here("R", "_setup.R"))
```

<!-- badges: start -->
[![Project Status: Active – The project has reached a stable, usable state and is being actively developed.](https://www.repostatus.org/badges/latest/active.svg)](https://www.repostatus.org/#active)
[![License: GPLv3](https://img.shields.io/badge/license-GPLv3-bd0000.svg)](https://www.gnu.org/licenses/gpl-3.0)
[![License: CC BY-NC-SA 4.0](https://img.shields.io/badge/license-CC_BY--NC--SA_4.0-lightgrey.svg)](https://creativecommons.org/licenses/by-nc-sa/4.0/)
<!-- badges: end -->

## Overview

This report provides a reproducible pipeline for calculating the Maximal Coverage [Location-Allocation](https://en.wikipedia.org/wiki/Location-allocation) to identify optimal sites for fresh and/or healthy food establishments in favelas (informal settlements in Brazil) and urban communities. The goal is to improve accessibility and maximize coverage within the study region.

For instructions on how to run the pipeline, see the repository [README](https://github.com/cem-usp/locais-nova-location-allocation/blob/main/README.md).

## Problem

The [AcessoSAN](https://doi.org/10.17605/OSF.IO/ZE6WT) project aims to develop methods for measuring and analyzing inequities in access to fresh and/or healthy food in favelas (informal settlements in Brazil) and other urban communities. Achieving this requires mapping the current food environment and identifying optimal locations for new food establishments to improve accessibility. This pipeline addresses this need by providing a systematic approach to [location-allocation](https://en.wikipedia.org/wiki/Location-allocation) analysis using the Locais-Nova scale groups [@silva2025].

## Data Availability

<!-- Add OSF badge. -->

The processed data are available in [`csv`](https://en.wikipedia.org/wiki/Comma-separated_values), [`rds`](https://rdrr.io/r/base/readRDS.html) and [`parquet`](https://en.wikipedia.org/wiki/Apache_Parquet) formats through dedicated repositories on the Open Science Framework ([OSF](https://osf.io/)). A metadata file is included alongside the validated datasets.

Only authorized personnel can access the pipeline **raw** and **processed** files. They are protected with [RSA](https://en.wikipedia.org/wiki/RSA_cryptosystem) 4096-bit encryption ([OpenSSL](https://www.openssl.org/)) and a 32-byte password to ensure data security.

## Methods

### Source of Data

The data used in this report come from the following sources:

- Brazilian Federal Revenue Service ([RFB](https://www.gov.br/receitafederal/))
  - Legal entities data from the National Register of Legal Entities ([CNPJ](https://en.wikipedia.org/wiki/CNPJ)) [database](https://dados.gov.br/dados/conjuntos-dados/cadastro-nacional-da-pessoa-juridica---cnpj), used for company identification [@brasil].
  - Codes of Brazilian agencies and municipalities (_Tabela de Órgãos e Municípios_, [TOM]((https://dados.gov.br/dados/conjuntos-dados/tabela-de-rgos-e-municpios))) [@brasila], used to identify municipalities in the CNPJ database.
- Brazilian Institute of Geography and Statistics ([IBGE](https://www.ibge.gov.br/))
  - Codes and descriptions from the National Classification of Economic Activities ([CNAE](https://concla.ibge.gov.br/concla.html)) [@ibgeu], used to match establishments to the Locais-Nova groups.
  - Tract shapes from the [Brazilian 2022 Census](https://www.ibge.gov.br/en/statistics/social/labor/22836-2022-census-3.html) via the [`geobr`](https://ipeagit.github.io/geobr/) R package [@pereirab], used to calculate population density.
  - Tract population data from the [Brazilian 2022 Census](https://www.ibge.gov.br/en/statistics/social/labor/22836-2022-census-3.html) via the [`censobr`](https://ipeagit.github.io/censobr/) R package [@pereirab], used to calculate population density.
  - Open spatial datasets of Brazilian addresses from the National Address Register for Statistical Purposes ([CNEFE](https://www.ibge.gov.br/estatisticas/sociais/populacao/38734-cadastro-nacional-de-enderecos-para-fins-estatisticos.html)), used for geocoding the establishments via the [`geocodebr`](https://ipeagit.github.io/geocodebr/) R package [@pereiraa].
- Center for Metropolitan Studies ([CEM](https://centrodametropole.fflch.usp.br/))
  - Lookup table providing the classification linking the establishments [CNAEs](https://www.gov.br/receitafederal/pt-br/assuntos/orientacao-tributaria/cadastros/cnpj/classificacao-nacional-de-atividades-economicas-2013-cnae) codes to the [Locais-Nova](https://doi.org/10.1590/S2237-96222025v34.20240361.en) groups (Fernandes & Giannotti, 2025). This data will remain private until further notice.
- Malaria Atlas Project ([MAP](https://malariaatlas.org/))
  - [Spatial friction](https://en.wikipedia.org/wiki/Friction_of_distance) data based on the *Global Walking Only Friction Surface* dataset [@map2019a], used to calculate travel times.
- OpenStreetMap ([OSM](https://www.openstreetmap.org/))
  - [Road and footpaths](https://wiki.openstreetmap.org/wiki/Map_features#Highway) spatial data [@openstreetmap], used to calculate travel times.

The dataset related to the Brazilian Federal Revenue Service ([RFB](https://www.gov.br/receitafederal/)) used in this report was processed by Vartanian et al. [-@vartanian2025z] and has its own dedicated pipeline, which can be accessed at: <https://cem-usp.github.io/locais-nova-rfb-geocoding>

### Data Munging

The data munging follow the data science workflow outlined by @wickham2023e, as illustrated in [@fig-wickham-at-al-2023-figure-1]. All processes were made using the [Quarto](https://quarto.org/) publishing system [@allaire], the [R](https://www.r-project.org/) programming language [@rcoreteama] and several R packages.

For data manipulation and workflow, priority was given to packages from the [tidyverse](https://www.tidyverse.org/), [rOpenSci](https://ropensci.org/) and [r-spatial](https://r-spatial.org/) ecosystems, as well as other packages adhering to the tidy tools manifesto [@wickham2023c].

::: {#fig-wickham-at-al-2023-figure-1}
![](images/wickham-at-al-2023-figure-1.png){width=75%}

[Source: Reproduced from @wickham2023e.]{.legend}

Data science workflow created by Wickham, Çetinkaya-Runde, and Grolemund.
:::

### Code Style

The Tidyverse [Tidy Tools Manifesto](https://tidyverse.tidyverse.org/articles/manifesto.html) [@wickham2023c], [code style guide](https://style.tidyverse.org/) [@wickhamb] and [design principles](https://design.tidyverse.org/) [@wickhamc] were followed to ensure consistency and enhance readability.

### Reproducibility

The pipeline is fully reproducible and can be run again at any time. To ensure consistent results, the [`renv`](https://rstudio.github.io/renv/) package [@usheya] is used to manage and restore the R environment. See the [README](https://github.com/cem-usp/locais-nova-location-allocation/blob/main/README.md) file in the code repository to learn how to run it.

## Set the Environment

::: {.callout-note}
This section sets up the R environment needed for the workflow.
:::

### Load Packages

```{r}
#| label: Set the Environment
#| code-fold: false
#| output: false

library(askpass)
library(arrow)
library(brandr)
library(beepr)
library(censobr)
library(cli)
library(curl)
library(dplyr)
library(fs)
library(ggplot2)
library(ggspatial)
library(geobr)
library(here)
library(htmltools)
library(leaflet)
# install.packages("remotes")
# remotes::install_github("danielvartan/locationallocation")
library(locationallocation)
# remotes::install_github("danielvartan/lockr")
library(lockr) # github.com/danielvartan/lockr
library(magrittr)
library(nngeo)
# remotes::install_github("danielvartan/orbis")
library(orbis) # github.com/danielvartan/orbis
library(osfr)
library(raster)
library(readr)
library(sf)
library(stars)
library(stringr)
library(tidyr)
library(readxl)
library(zip)
```

### Set Keys

::: {.callout-note}
See the [Data Availability](#data-availability) section for more information.
:::

```{r}
#| eval: false
#| output: false

osf_auth(Sys.getenv("OSF_PAT")) # askpass())
```

```{r}
public_key <- here("_ssh", "id_rsa.pub")
```

```{r}
private_key <- here("_ssh", "id_rsa")
```

```{r}
password <- Sys.getenv("ACESSOSAN_PASSWORD") # askpass()
```

### Set Data Directory

```{r}
data_dir <- here("data")
```

```{r}
if (!dir_exists(data_dir)) dir_create(data_dir, recurse = TRUE)
```

### Set Initial Variables

```{r}
set.seed(2025)
```

::: {.callout-note}
The `year` variable is related to the year of the [RFB](https://www.gov.br/receitafederal/) dataset. At the moment, only the 2025 dataset is available.
:::

```{r}
year <- 2025
```

::: {.callout-note}
The `locais_nova_group` variable defines the Locais-Nova scale group [@silva2025]to be analyzed. This pipeline utilizes the Locais-Nova scale groups to classify food establishments.

The `G0` group is a distinct subset comprising establishments from the `G1-G2` group that are not simultaneously classified under `G3` or `G4`.
:::

```{r}
locais_nova_group <- "G0" # G1-G2, G3, G4
```

::: {.callout-note}
The `objective_minutes` variable defines the maximum travel time (in minutes) for coverage analysis.
:::

```{r}
objective_minutes <- 15
```

::: {.callout-note}
The `favela` variable specifies the IBGE code of the favela to be analyzed. Select only **one** for analysis by uncommenting the corresponding IBGE code.
:::

```{r}
favela <- c(
  # 35503080012 # Heliópolis (São Paulo-SP)
  35503080492 # Paraisópolis (São Paulo-SP)
  # 35503080435 # Nova Jaguaré (São Paulo-SP)
  # 35503081093 # Recanto do Paraíso (São Paulo-SP)
  # 35503080376 # Jardim Iporanga / Esmeralda (São Paulo-SP)
)
```

```{r}
municipality_code <-
  favela |>
  str_sub(1, 7) |>
  as.integer()
```

## Download RFB Data

::: {.callout-note}
See the [Source of Data](#source-of-data) section for more information.
:::

### Download File

```{r}
#| label: Download RFB Data

osf_raw_data_id <- "2x6jb"
```

```{r}
osf_raw_data_files <-
  osf_raw_data_id |>
  osf_retrieve_node() |>
  osf_ls_files(
    type = "file",
    pattern = "2025-01.rds.lockr",
    n_max = Inf
  )
```

```{r}
osf_raw_data_files
```

```{r}
#| eval: false

rfb_file <-
  osf_raw_data_files |>
  osf_download(path = data_dir, conflicts = "overwrite") |>
  extract2("local_path")
```

### Unlock File

```{r}
#| eval: false
#| include: false

rfb_file <- here(data_dir, "2025-01.rds.lockr")
```

```{r}
#| eval: false
#| output: false

rfb_file |>
  unlock_file(
    private_key = private_key,
    suffix = ".lockr",
    remove_file = TRUE,
    password = password
  )
```

## Download and Import IBGE CNAE Data

::: {.callout-note}
See the [Source of Data](#source-of-data) section for more information.
:::

### Download Data

```{r}
#| eval: false
#| label: Download and Import IBGE CNAE Data

cnae_file <-
  file.path(
    "https:/",
    "concla.ibge.gov.br/images/concla/documentacao",
    "CNAE_Subclasses_2_3_Estrutura_Detalhada.xlsx"
) |>
  curl_download(
    here(data_dir, "CNAE_Subclasses_2_3_Estrutura_Detalhada.xlsx")
  )
```

```{r}
#| include: false

cnae_file <- here(data_dir, "CNAE_Subclasses_2_3_Estrutura_Detalhada.xlsx")
```

### Import Data

```{r}
cnae_data <-
  cnae_file |>
  read_xlsx(
    sheet = "Estrutura Det. CNAE Subclass2.3",
    range = "E5:F2401",
    col_names = c("cnae", "description")
  ) |>
  drop_na(cnae) |>
  mutate(
    cnae =
      cnae |>
      str_extract_all("\\d") |>
      lapply(paste, collapse = "") |>
      unlist()
  )
```

```{r}
cnae_data |> glimpse()
```

## Download and Import Census Tract Population Data

::: {.callout-note}
See the [Source of Data](#source-of-data) section for more information.
:::


```{r}
#| label: Download and Import Census Tract Population Data
#| eval: false
#| include: false

data_dictionary(
  year = 2022, # Last available year
  dataset = "tracts"
)
```

```{r}
census_population_data <-
  read_tracts(
    year = 2022, # Last available year
    dataset = "Basico",
    as_data_frame = FALSE,
    showProgress = TRUE,
    cache = TRUE,
    verbose = TRUE
  )
```

```{r}
census_population_data |> glimpse()
```

## Download and Import Census Tract Shape Data

::: {.callout-note}
See the [Source of Data](#source-of-data) section for more information.
:::

```{r}
#| label: Download and Import Census Tract Shape Data

census_tract_data <-
  read_census_tract(
    code_tract = municipality_code,
    year = 2022, # Last available year
    simplified = TRUE,
    showProgress = TRUE,
    cache = TRUE
  )
```

```{r}
census_tract_data |> glimpse()
```

## Explore Favela Data

### Filter Census Population Data

```{r}
favela_data <-
  census_population_data |>
  filter(
    code_muni == .env$municipality_code,
    !is.na(code_favela)
  ) |>
  collect() |>
  as_tibble()
```

### Explore Data

```{r}
favela_data |> glimpse()
```

```{r}
favela_data |>
  pull(name_favela) |>
  unique() |>
  length()
```

```{r}
favela_data |>
  dplyr::select(code_favela, name_favela) |>
  arrange(name_favela) |>
  distinct()
```

```{r}
#| eval: false
#| include: false

favela_data |>
  filter(
    name_favela |>
    str_detect(regex("(?i)heliópolis", ignore_case = TRUE))
  ) |>
  distinct(code_favela, name_favela) |>
  print(n = Inf)
```

## Filter and Join Census Data

```{r}
census_data <-
  census_population_data |>
  filter(
    code_muni == .env$municipality_code,
    code_favela == .env$favela
  ) |>
  dplyr::select(code_tract, V0001) |>
  rename(population = V0001) |>
  mutate(code_tract = as.numeric(code_tract)) |>
  collect() |>
  left_join(census_tract_data, by = "code_tract") |>
  rename(tract_code = code_tract) |>
  dplyr::select(tract_code, population, geom) |>
  st_as_sf()
```

```{r}
census_data |> glimpse()
```

## Create Favela Shape

```{r}
shape <-
  census_data |>
  st_geometry() |>
  st_union() |>
  st_make_valid() |>
  st_cast("POLYGON") |>
  nngeo::st_remove_holes() |>
  st_union(is_coverage = TRUE) |>
  st_as_sf()
```

```{r}
#| eval: false
#| include: false

census_data |> st_geometry() |> plot()
shape |> st_geometry() |> plot()
```

## Import Data

```{r}
#| label: Import Data

data <-
  here(data_dir, "2025-01.rds") |>
  read_rds()
```

## Filter Data

```{r}
data <-
  data |>
  filter(
    municipality_code == .env$municipality_code,
    geocodebr_precision %in% c("numero", "numero_aproximado")
  ) |>
  dplyr::select(
    cnpj,
    cnae,
    longitude,
    latitude,
    locais_nova_g0,
    locais_nova_g1_g2,
    locais_nova_g3,
    locais_nova_g4
  )
```

## Transform Data

```{r}
data <-
  data |>
  st_as_sf(coords = c("longitude", "latitude"), crs = st_crs(shape)) |>
  pivot_longer(
    cols = starts_with("locais_nova_"),
    names_to = "group",
    values_to = "value"
  ) |>
  filter(value == TRUE) |>
  mutate(
    group =
      group |>
      str_remove("locais_nova_") |>
      str_to_upper() |>
      str_replace("_", "-")
  ) |>
  st_join(shape, join = st_within, left = FALSE) |>
  dplyr::select(cnpj, cnae, group, geometry)
```

## Explore the Data

### Glimpse Data

```{r}
data |> glimpse()
```

### Show Favela on Leaflet

```{r}
shape_centroid <-
  shape |>
  st_centroid() |>
  st_coordinates() |>
  as.numeric()
```

```{r}
leaflet() |>
  addTiles() |>
  setView(
    lng = shape_centroid[1],
    lat = shape_centroid[2],
    zoom = 15
  ) |>
  addPolygons(
    data = shape |> st_transform(st_crs("WGS84")),
    fillColor = "transparent",
    color = "blue",
    weight = 2,
    opacity = 1
  )
```

### Plot Establishments

::: {.callout-note}
This plot illustrates the distribution of food establishments categorized by Locais-Nova scale groups [@silva2025]. Note that an establishment may belong to multiple groups.
:::

```{r}
#| fig-width: 9
#| fig-height: 3

ggplot() +
  geom_sf(
    data = shape,
    fill = "gray90",
    color = "black"
  ) +
  geom_sf(
    data = data,
    mapping = aes(color = group),
    size = 0.01
  ) +
  facet_wrap(~ group, ncol = 4) +
  coord_sf(crs = 4326) +
  scale_color_brand_d() +
  scale_x_continuous(labels = NULL, breaks = NULL) +
  scale_y_continuous(labels = NULL, breaks = NULL) +
  theme(legend.position = "none") +
  labs(
    x = NULL,
    y = NULL,
    color = NULL
  )
```

### Plot Tract Population

::: {.callout-note}
This plot illustrates the population distribution across census tracts within the selected favela.
:::

```{r}
ggplot() +
  geom_sf(
    data = shape,
    fill = "gray90",
    color = "black"
  ) +
  geom_sf(
    data = census_data,
    mapping = aes(fill = population),
    color = NA
  ) +
  scale_fill_viridis_c(option = "plasma") +
  coord_sf(crs = 4326) +
  annotation_scale(
    location = "br",
    style = "tick",
    height = unit(0.5, "lines")
  ) +
  annotation_north_arrow(
    location = "br",
    height = unit(2, "lines"),
    width = unit(2, "lines"),
    pad_x = unit(0.25, "lines"),
    pad_y = unit(1.25, "lines"),
    style = north_arrow_fancy_orienteering
  ) +
  theme(legend.position = "right") +
  labs(
    x = NULL,
    y = NULL,
    fill = "Population"
  )
```

## Compute Maximal Coverage Location-Allocation (With Restaurants)

::: {.callout-warning}
The Locais-Nova scale add _restaurants_ ([CNAE](https://www.ibge.gov.br/en/statistics/technical-documents/statistical-lists-and-classifications/17245-national-classification-of-economic-activities.html?=&t=o-que-e) 5611-2/01) as potential establishments for fresh and/or healthy food access. But not all restaurants offer such options (e.g., burger joints, pizza places, etc.). Therefore, results should be interpreted with caution.
:::

### Filter Locais-Nova Group

```{r}
#| label: Compute Maximal Coverage Location-Allocation (With Restaurants)

allocation_data <-
  data |>
  filter(group == "G0") |>
  st_transform(st_crs("WGS84"))
```

### Check Allocation Data

```{r}
unique_cnaes <-
  allocation_data |>
  pull(cnae) |>
  unique() |>
  sort()
```

```{r}
cnae_data |>
  filter(
    cnae |>
      magrittr::is_in(
        unique_cnaes |>
          str_extract_all("\\d") |>
          lapply(paste, collapse = "") |>
          unlist()
      )
  )
```

```{r}
allocation_data |> glimpse()
```

```{r}
allocation_data
```

### Normalize Favela Shape CRS

```{r}
allocation_shape <-
  shape |>
  st_transform(st_crs("WGS84"))
```

### Plot Food Establishments

::: {.callout-note}
This plot illustrates the spatial distribution of food establishments within the selected Locais-Nova scale group.
:::

#### Plot Establishments

```{r}
#| label: Plot Food Establishments (With Restaurants)

ggplot() +
  geom_sf(
    data = shape,
    fill = "gray90",
    color = "black"
  ) +
  geom_sf(
    data = allocation_data,
    color = get_brand_color("blue"),
    size = 1
  ) +
  coord_sf(crs = "WGS84") +
  annotation_scale(
    location = "br",
    style = "tick",
    height = unit(0.5, "lines")
  ) +
  annotation_north_arrow(
    location = "br",
    height = unit(2, "lines"),
    width = unit(2, "lines"),
    pad_x = unit(0.25, "lines"),
    pad_y = unit(1.25, "lines"),
    style = north_arrow_fancy_orienteering
  ) +
  scale_color_brand_d() +
  theme(legend.position = "none") +
  labs(x = NULL, y = NULL)
```

#### Show Establishments on Leaflet

```{r}
shape_centroid <-
  shape |>
  st_centroid() |>
  st_coordinates() |>
  as.numeric()
```

```{r}
point_coordinates <-
  allocation_data |>
  mutate(
    latitude = st_coordinates(geometry)[, 2],
    longitude = st_coordinates(geometry)[, 1]
  ) |>
  dplyr::select(cnpj, latitude, longitude) |>
  st_drop_geometry()
```

```{r}
leaflet() |>
  addTiles() |>
  setView(
    lng = shape_centroid[1],
    lat = shape_centroid[2],
    zoom = 15
  ) |>
  addMarkers(
    lng = point_coordinates$longitude,
    lat = point_coordinates$latitude,
    popup = point_coordinates$cnpj
  )
```

### Compute Travel Time

::: {.callout-warning}
This process may require substantial computational resources, depending on the area's size and the number of establishments analyzed. Ensure your system has adequate capacity before proceeding.
:::

```{r}
#| label: Compute Travel Time (With Restaurants)
#| output: false

travel_time_data <-
  allocation_data |>
  traveltime(
    bb_area = allocation_shape,
    dowscaling_model_type = "lm",
    mode = "walk",
    res_output = 10
  )
```

### Plot Travel Time

::: {.callout-note}
This plot illustrates walking travel times from food establishments within the selected Locais-Nova scale group, considering the spatial friction of the area. Contour lines represent travel times up to the specified objective minutes.
:::

```{r}
#| label: Travel Time Plot (With Restaurants)

travel_time_data |>
  traveltime_plot(
    bb_area = allocation_shape,
    facilities = allocation_data,
    contour_traveltime = objective_minutes
  )
```

### Rasterize Population Data

```{r}
census_raster_data <-
  census_data |>
  dplyr::select(-tract_code) |>
  st_transform(st_crs("WGS84")) |>
  st_rasterize() |>
  as("Raster")
```

### Compute Travel Time Stats

::: {.callout-note}
This plot illustrates the cumulative population coverage achieved within the specified travel time intervals from food establishments in the selected Locais-Nova scale group, highlighting accessibility patterns and potential gaps in coverage.
:::

```{r}
#| label: Travel Time Stats (With Restaurants)

travel_time_stats <-
  travel_time_data |>
  traveltime_stats(
    demand = census_raster_data,
    breaks = c(5, 10, 15, 30),
    objectiveminutes = objective_minutes
  )
```

## Compute Maximal Coverage Location-Allocation (Without Restaurants)

### Filter Allocation Data

```{r}
#| label: Compute Maximal Coverage Location-Allocation (Without Restaurants)

allocation_data <-
  allocation_data |>
  filter(!cnae == "5611-2/01") |>
  st_transform(st_crs("WGS84"))
```

### Check Allocation Data

```{r}
unique_cnaes <-
  allocation_data |>
  pull(cnae) |>
  unique() |>
  sort()
```

```{r}
cnae_data |>
  filter(
    cnae |>
      magrittr::is_in(
        unique_cnaes |>
          str_extract_all("\\d") |>
          lapply(paste, collapse = "") |>
          unlist()
      )
  )
```

```{r}
allocation_data |> glimpse()
```

```{r}
allocation_data
```

### Normalize Favela Shape CRS

```{r}
allocation_shape <-
  shape |>
  st_transform(st_crs("WGS84"))
```

### Plot Food Establishments

::: {.callout-note}
This plot illustrates the spatial distribution of food establishments within the selected Locais-Nova scale group.
:::

#### Plot Establishments

```{r}
#| label: Plot Food Establishments (Without Restaurants)

ggplot() +
  geom_sf(
    data = shape,
    fill = "gray90",
    color = "black"
  ) +
  geom_sf(
    data = allocation_data,
    color = get_brand_color("blue"),
    size = 1
  ) +
  coord_sf(crs = "WGS84") +
  annotation_scale(
    aes(),
    location = "br",
    style = "tick",
    height = unit(0.5, "lines")
  ) +
  annotation_north_arrow(
    location = "br",
    height = unit(2, "lines"),
    width = unit(2, "lines"),
    pad_x = unit(0.25, "lines"),
    pad_y = unit(1.25, "lines"),
    style = north_arrow_fancy_orienteering
  ) +
  scale_color_brand_d() +
  theme(legend.position = "none") +
  labs(x = NULL, y = NULL)
```

#### Show Establishments on Leaflet

```{r}
shape_centroid <-
  shape |>
  st_centroid() |>
  st_coordinates() |>
  as.numeric()
```

```{r}
point_coordinates <-
  allocation_data |>
  mutate(
    latitude = st_coordinates(geometry)[, 2],
    longitude = st_coordinates(geometry)[, 1]
  ) |>
  dplyr::select(cnpj, latitude, longitude) |>
  st_drop_geometry()
```

```{r}
leaflet() |>
  addTiles() |>
  setView(
    lng = shape_centroid[1],
    lat = shape_centroid[2],
    zoom = 15
  ) |>
  addMarkers(
    lng = point_coordinates$longitude,
    lat = point_coordinates$latitude,
    popup = point_coordinates$cnpj
  )
```

### Compute Travel Time

::: {.callout-warning}
This process may require substantial computational resources, depending on the area's size and the number of establishments analyzed. Ensure your system has adequate capacity before proceeding.
:::

```{r}
#| label: Compute Travel Time (Without Restaurants)
#| output: false

travel_time_data <-
  allocation_data |>
  traveltime(
    bb_area = allocation_shape,
    dowscaling_model_type = "lm",
    mode = "walk",
    res_output = 10
  )
```

### Plot Travel Time

::: {.callout-note}
This plot illustrates walking travel times to food establishments within the selected Locais-Nova scale group, considering the spatial friction of the area using [surface roughness](https://data.malariaatlas.org/maps?layers=Accessibility:202001_Global_Walking_Only_Friction_Surface&extent=-5374476.139299919,-2804556.46475387,-4931760.0211486025,-2595649.7965012174) along with roads, streets and paths (see the OpenStreetMap [`highway`](https://wiki.openstreetmap.org/wiki/Key:highway) key to learn more). Contour lines represent travel times up to the specified objective minutes.
:::

```{r}
#| label: Travel Time Plot (Without Restaurants)

travel_time_data |>
  traveltime_plot(
    bb_area = allocation_shape,
    facilities = allocation_data,
    contour_traveltime = objective_minutes
  )
```

### Rasterize Population Data

```{r}
census_raster_data <-
  census_data |>
  dplyr::select(-tract_code) |>
  st_transform(st_crs("WGS84")) |>
  st_rasterize() |>
  as("Raster")
```

### Compute Travel Time Stats

::: {.callout-tip}
You can compare this result with the food deserts and food swamps identified on the [Alimenta Cidades](https://alimentacidades.digital/#desertos) platform.
:::

```{r}
#| label: Travel Time Stats (Without Restaurants)

travel_time_stats <-
  travel_time_data |>
  traveltime_stats(
    demand = census_raster_data,
    breaks = c(5, 10, 15, 30),
    objectiveminutes = objective_minutes
  )
```

## Citation

::: {.callout-important}
When using this data, you must also cite the original data sources.
:::

To cite this work, please use the following format:

Vartanian, D., Silva, L. G., Fernandes, C. N., & Giannotti, M. A. (2025). *A reproducible pipeline for maximal coverage location-allocation of food establishments in Brazil using the Locais-Nova scale* \[Computer software\]. Center for Metropolitan Studies of the University of São Paulo. <https://cem-usp.github.io/locais-nova-location-allocation>

A BibLaTeX entry for LaTeX users is:

```latex
@software{silva2025,
  title = {A reproducible pipeline for maximal coverage location-allocation of food establishments in Brazil using the Locais-Nova scale},
  author = {{Daniel Vartanian} and {Letícia Gonçalves Silva} and {Camila Nastari Fernandes} and {Mariana Abrantes Giannotti}},
  year = {2025},
  address = {São Paulo},
  institution = {Center for Metropolitan Studies of the University of São Paulo},
  langid = {en},
  url = {https://cem-usp.github.io/locais-nova-location-allocation}
}
```

## License

::: {style="text-align: left;"}
[![License: GPLv3](https://img.shields.io/badge/license-GPLv3-bd0000.svg)](https://www.gnu.org/licenses/gpl-3.0)
[![License: CC BY-NC-SA 4.0](https://img.shields.io/badge/license-CC_BY--NC--SA_4.0-lightgrey.svg)](https://creativecommons.org/licenses/by-nc-sa/4.0/)
:::

::: {.callout-important}
The original data sources may be subject to their own licensing terms and conditions.
:::

The code in this repository is licensed under the [GNU General Public License Version 3](https://www.gnu.org/licenses/gpl-3.0), while the report is available under the [Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International](https://creativecommons.org/licenses/by-nc-sa/4.0/).

```
Copyright (C) 2025 Center for Metropolitan Studies

The code in this report is free software: you can redistribute it and/or
modify it under the terms of the GNU General Public License as published by the
Free Software Foundation, either version 3 of the License, or (at your option)
any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY
WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
PARTICULAR PURPOSE. See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with
this program. If not, see <https://www.gnu.org/licenses/>.
```

## Acknowledgments

```{r, results='asis'}
#| eval: true
#| echo: false

blocks <- list(
  list(
    logo_link = "https://doi.org/10.17605/OSF.IO/ZE6WT",
    logo_src = "images/acessosan-logo.svg",
    logo_alt = "AcessoSAN Logo",
    logo_width = 140,
    text = 'This work is part of a research project by the Polytechnic School (<a href="https://www.poli.usp.br/">Poli</a>) of the University of São Paulo (<a href="https://usp.br/">USP</a>), in partnership with the Secretariat for Food and Nutrition Security (<a href="https://www.gov.br/mds/pt-br/orgaos/SESAN">SESAN</a>) of the Ministry of Social Development, Family, and the Fight Against Hunger (<a href="https://www.gov.br/mds/">MDS</a>), titled: <em>AcessoSAN: Mapping Food Access to Support Public Policies on Food and Nutrition Security and Hunger Reduction in Brazilian Cities</em>.'
  ),
  list(
    logo_link = "https://centrodametropole.fflch.usp.br",
    logo_src = "images/cem-icon.svg",
    logo_alt = "CEM Logo",
    logo_width = 190,
    text = 'This work was developed with support from the Center for Metropolitan Studies (<a href="https://centrodametropole.fflch.usp.br">CEM</a>) based at the School of Philosophy, Letters and Human Sciences (<a href="https://www.fflch.usp.br/">FFLCH</a>) of the University of São Paulo (<a href="https://usp.br">USP</a>) and at the Brazilian Center for Analysis and Planning (<a href="https://cebrap.org.br/">CEBRAP</a>).'
  ),
  list(
    logo_link = "https://fapesp.br/",
    logo_src = "images/fapesp-logo.svg",
    logo_alt = "FAPESP Logo",
    logo_width = 160,
    text = 'This study was financed, in part, by the São Paulo Research Foundation (<a href="https://fapesp.br/">FAPESP</a>), Brazil. Process Number <a href="https://bv.fapesp.br/en/bolsas/231507/geospatial-data-science-applied-to-food-policies/">2025/17879-2</a>.'
  )
)

blocks |>
  lapply(
    function(x) {
      div(
        style = paste0(
          "display: flex; ",
          "align-items: flex-start; ",
          "margin-bottom: 2em;"
        ),
        div(
          style = paste0(
            "flex: 0 0 30%; ",
            "display: flex; ",
            "justify-content: center; ",
            "margin: auto 0;"
          ),
          tags$a(
            href = x$logo_link,
            tags$img(
              src = x$logo_src,
              alt = x$logo_alt,
              style = paste0(
                "max-width: ", x$logo_width, "px; ",
                "width: 100%; ",
                "height: auto;"
              )
            )
          )
        ),
        div(
          style = paste0(
            "flex: 1; ",
            "padding-left: 1em;"
          ),
          HTML(x$text)
        )
      )
    }
  ) |>
  tagList() |>
  browsable()
```

## References {.unnumbered}

::: {#refs}
:::
